<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="post-install" default="post-install" basedir=".">
	<property file="post-install.properties"/>
	<import file="common-tasks.xml"/>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
	
	<target name="post-install" depends="import-wrappers,										
					     				set-subst-vars,
										update-fdsecure-files,
										set-perm,
										bkp-files">
		<echo message="Done post-installation tasks." />
	</target>

	<target name="import-wrappers">
	</target>
	
	<target name="set-subst-vars">
		<antcall target="substitute-variables-examples">
			<param name="examples-path" value="${tibco.home}/be/${beVersionShort}/examples/standard" />
		</antcall>
		<antcall target="substitute-variables-examples"><!-- Replace the tokens in files under api/channel-api/examples -->
			<param name="examples-path" value="${tibco.home}/be/${beVersionShort}/api/channel-api/examples" />
		</antcall>
		<if>
			<available file="${tibco.home}/be/${beVersionShort}/examples/liveview" type="dir"/>
			<then>
				<antcall target="substitute-variables-examples">
					<param name="examples-path" value="${tibco.home}/be/${beVersionShort}/examples/liveview" />
				</antcall>
			</then>
		</if>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/examples/standard/RuleFunctionAPI/RuleFunction/project/bin/setenv.sh"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/examples/standard/RuleFunctionAPI/RuleFunction/project/bin/setenv.bat"/>
		</antcall>
	</target>
	
	<target name="update-fdsecure-files">
			<replace file="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/fdpolicy.txt" token="%TIBCO_BE_HOME_ESC%" value="${tibco.home}/be/${beVersionShort}" />
			<unjar dest="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/temp_ear" src="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/fdsecure.ear">
		    </unjar>
			<replace file="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/temp_ear/TIBCO.xml" token="%TIBCO_BE_HOME_ESC%" value="${tibco.home}/be/${beVersionShort}" />
		    <delete file="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/fdsecure.ear" />
		    <jar destfile="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/fdsecure.ear" basedir="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/temp_ear">
		    </jar>
		    <delete dir="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/temp_ear" />
			<replace file="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/FraudDetectionSecure/defaultVars/defaultVars.substvar" token="%TIBCO_BE_HOME_ESC%" value="${tibco.home}/be/${beVersionShort}" />
	  		<replace file="${tibco.home}/be/${beVersionShort}/examples/standard/FraudDetectionSecure/FraudDetectionSecure/fdsecure.cdd" token="%TIBCO_BE_HOME_ESC%" value="${tibco.home}/be/${beVersionShort}" />
		</target>
	
	<target name="set-perm">
		<chmod perm="755">
			<fileset dir="${tibco.home}/be/${beVersionShort}/examples/standard" casesensitive="no">
					<include name="**/*.sh"/>
			</fileset>
		</chmod>
	</target>
	
	<target name="bkp-files">
		<echo message="Backing Up creditcard-app-files" />
		
		<if>
			<available file="${tibco.home}/be/5.4/examples/standard/WebStudio/CreditCardApplication/Events" type="dir"/>
			<then>
				<mkdir dir="${tibco.home}/be/5.4/backup/5.4.1_pre/examples/standard/WebStudio/CreditCardApplication/Events" />
				<move todir="${tibco.home}/be/5.4/backup/5.4.1_pre/examples/standard/WebStudio/CreditCardApplication/Events">
					<fileset dir="${tibco.home}/be/5.4/examples/standard/WebStudio/CreditCardApplication/Events">
						<include name="AddNewApplicant.event"/>
						<include name="AddNewApplicant_EndEvent.event"/>
						<include name="ProcessNewCreditCardApplicationEvent.event"/>
						<include name="ProcessNewCreditCardApplication_EndEvent.event"/>
					</fileset>
				</move>
			</then>
		</if>		

		<if>
			<available file="${tibco.home}/be/5.4/examples/standard/WebStudio/CreditCardApplication/Processess" type="dir"/>
			<then>
				<mkdir dir="${tibco.home}/be/5.4/backup/5.4.1_pre/examples/standard/WebStudio/CreditCardApplication/Processess" />
				<move todir="${tibco.home}/be/5.4/backup/5.4.1_pre/examples/standard/WebStudio/CreditCardApplication/Processess">
					<fileset dir="${tibco.home}/be/5.4/examples/standard/WebStudio/CreditCardApplication/Processess">
						<include name="AddNewApplicant.beprocess"/>
						<include name="CreditCardApplicationProcess.beprocess"/>
					</fileset>
				</move>
			</then>
		</if>
	</target>
	
</project>	
