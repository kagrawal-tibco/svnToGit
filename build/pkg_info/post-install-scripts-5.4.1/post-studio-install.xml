<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="post-install" default="post-install" basedir=".">
	<property file="post-install.properties"/>
	<import file="common-tasks.xml"/>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

	<target name="post-install" depends="import-wrappers,
					     				set-subst-vars,
					     				set-studio-permissions,
					     				import-studio-link-files,
										update-tra-files,
										backup-designtime-plugins">
		<echo message="Done post-installation tasks." />
	</target>

	<target name="import-wrappers">
		<echo message="Copying studio-tools wrapper..." />
		<copy file="${tibco.home}/tools/wrapper/wrap${tibco.wrapper.extension}"
			tofile="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools${tibco.wrapper.extension}" />
		<chmod file="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools${tibco.wrapper.extension}" perm="755" />
	</target>

	<target name="set-subst-vars">
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools.tra"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/configuration/studio.tra"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins/TIBCOBusinessEvents-EclipsePlatform-plugins.link"/>
		</antcall>
		<if>
			<available file="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link" type="file"/>
			<then>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
				</antcall>
			</then>
		</if>
		<if>
			<os family="mac"/>
			<then>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.app/Contents/MacOS/studio.ini"/>
				</antcall>
				<if>
					<available file="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/Eclipse.app/Contents/Eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link" type="file"/>
					<then>
						<antcall target="substitute-variables">
							<param name="out.file" value="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/Eclipse.app/Contents/Eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
						</antcall>
					</then>
				</if>
			</then>
			<else>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.ini"/>
				</antcall>
			</else>
		</if>
		<!--repo installer-->
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo.bat"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo.xml"/>
		</antcall>

	</target>

	<target name="set-studio-permissions">
		<chmod dir="${tibco.home}/be/${beVersionShort}/studio" perm="755" includes="**/*" />
	</target>

	<target name="import-studio-link-files">
		<!--
		<if>
			<or>
				<isset property="eclipse.home.esc"/>
	            <not>
	                <equals arg1="${eclipse.home.esc}" arg2=""/>
	            </not>
	        </or>
			<then>
				<copy file="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins_configuration/TIBCOBusinessEvents-Studio-plugins.link"
		        	tofile="${eclipse.home.esc}/links/TIBCOBusinessEvents-Studio-plugins.link" overwrite="true" />
			</then>
		</if>
		-->
	</target>
	<target name="update-tra-files">
		<antcall target="update-tra">
			<param name="update.file" value="${tibco.home}/be/5.4/studio/bin/studio-tools.tra"/>
			<param name="update.operation" value="replace-value"/>
			<param name="update.property" value="tibco.env.STD_EXT_CP"/>
			<param name="update.value" value="%BE_STUDIO_HOME%/eclipse/plugins%PSP%%BE_STUDIO_HOME%/bin%PSP%%ECLIPSE_HOME%/plugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar%PSP%%BE_ECLIPSE_HOME%/plugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar%PSP%%JDK_LIB%/tools.jar"/>
		</antcall>
	</target>
	
	<target name="backup-designtime-plugins">
		<echo message="Backing up designtime plugins" />
		<mkdir dir="${tibco.home}/be/5.4/backup/5.4.1_pre/studio/eclipse/plugins" />
		<move todir="${tibco.home}/be/5.4/backup/5.4.1_pre/studio/eclipse/plugins">
			<fileset dir="${tibco.home}/be/5.4/studio/eclipse/plugins">
				<include name="com.tibco.cep.diagramming_5.4.*.jar*"/>						
				<include name="com.tibco.cep.rt_5.4.*.jar*"/>						
				<include name="com.tibco.cep.sharedresource_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.application_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.cli_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.common_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.core_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.debug.core_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.debug.ui_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.mapper_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.tester.core_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.tester.ui_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.ui.editors_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.ui.navigator_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.ui_5.4.*.jar*"/>						
				<include name="com.tibco.cep.tpcl_5.4.*.jar*"/>						
				<include name="com.tibco.cep.tra_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.wizard.hawk_5.4.*.jar*"/>						
				<include name="com.tibco.cep.studio.wizard.as_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.ws_5.4.*.jar*"/>
				<include name="com.tibco.xml.*.jar*"/>
				<include name="com.tibco.cep.studio.xerces_5.4.*.jar*"/>
				<include name="com.tibco.cep.thirdparty_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.util_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.mapper.ui_5.4.*.jar*"/>
				<include name="com.tibco.cep.studio.dashboard.rt_5.4.*.jar*"/>
				<include name="com.tibco.cep.security_5.4.*.jar*"/>
				<include name="com.tibco.cep.eventstreamprocessing_5.4.*.jar*"/>
				<include name="com.tibco.cep.eventstreamprocessing.common_5.4.*.jar*"/>
				<include name="com.tibco.cep.datamodeling.common_5.4.*.jar*"/>
				<include name="com.tibco.cep.liveview_5.4.*.jar" />
				<exclude name="*5.4.1.jar"/>
			</fileset>
		</move>
	</target>
	
	
</project>
