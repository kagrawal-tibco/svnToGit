<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="post-install" default="post-install" basedir=".">
	<property file="post-install.properties"/>
	<import file="common-tasks.xml"/>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

	<target name="post-install" depends="import-wrappers,
					     				set-subst-vars,
					     				set-studio-permissions,
					     				import-studio-link-files,
										update-tra-files,
										backup-designtime-plugins" >
		<echo message="Done post-installation tasks." />
	</target>

	<target name="import-wrappers">
		<echo message="Copying studio-tools wrapper..." />
		<copy file="${tibco.home}/tools/wrapper/wrap${tibco.wrapper.extension}"
			tofile="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools${tibco.wrapper.extension}" />
		<chmod file="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools${tibco.wrapper.extension}" perm="755" />
	</target>

	<target name="set-subst-vars">
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/bin/studio-tools.tra"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/configuration/studio.tra"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins/TIBCOBusinessEvents-EclipsePlatform-plugins.link"/>
		</antcall>
		<if>
			<available file="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link" type="file"/>
			<then>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
				</antcall>
			</then>
		</if>
		<if>
			<os family="mac"/>
			<then>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.app/Contents/MacOS/studio.ini"/>
				</antcall>
				<if>
					<available file="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/Eclipse.app/Contents/Eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link" type="file"/>
					<then>
						<antcall target="substitute-variables">
							<param name="out.file" value="${tibco.home}/be/${beVersionShort}/eclipse-platform/eclipse/Eclipse.app/Contents/Eclipse/dropins/TIBCOBusinessEvents-Studio-plugins.link"/>
						</antcall>
					</then>
				</if>
			</then>
			<else>
				<antcall target="substitute-variables">
					<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.ini"/>
				</antcall>
			</else>
		</if>
		<!--repo installer-->
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo.bat"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo"/>
		</antcall>
		<antcall target="substitute-variables">
			<param name="out.file" value="${tibco.home}/be/${beVersionShort}/studio/repo/install_studio_repo.xml"/>
		</antcall>

	</target>

	<target name="set-studio-permissions">
		<chmod dir="${tibco.home}/be/${beVersionShort}/studio" perm="755" includes="**/*" />
	</target>

	<target name="import-studio-link-files">
		<!--
		<if>
			<or>
				<isset property="eclipse.home.esc"/>
	            <not>
	                <equals arg1="${eclipse.home.esc}" arg2=""/>
	            </not>
	        </or>
			<then>
				<copy file="${tibco.home}/be/${beVersionShort}/studio/eclipse/dropins_configuration/TIBCOBusinessEvents-Studio-plugins.link"
		        	tofile="${eclipse.home.esc}/links/TIBCOBusinessEvents-Studio-plugins.link" overwrite="true" />
			</then>
		</if>
		-->
	</target>
	<target name="update-tra-files">
		<antcall target="update-tra">
			<param name="update.file" value="${tibco.home}/be/5.6/studio/bin/studio-tools.tra"/>
			<param name="update.operation" value="replace-value"/>
			<param name="update.property" value="tibco.env.STD_EXT_CP"/>
			<param name="update.value" value="%BE_STUDIO_HOME%/eclipse/plugins%PSP%%BE_STUDIO_HOME%/bin%PSP%%ECLIPSE_HOME%/plugins/org.eclipse.equinox.launcher_1.5.400.v20190515-0925.jar%PSP%%BE_ECLIPSE_HOME%/plugins/org.eclipse.equinox.launcher_1.5.400.v20190515-0925.jar%PSP%%JDK_LIB%/tools.jar"/>
		</antcall>
	</target>
	<target name="init-studio">
        
		<echo message="OS Name is:         ${os.name}" />
        <echo message="OS Architecture is: ${os.arch}" />
        <echo message="OS Version is:      ${os.version}" />
		
        <if>
			<or>
				<os name="SunOS"/>
				<os arch="s390x"/>
				<os name="AIX"/>
				<os arch="HP-UX"/>
				<os name="HP-UX"/>
			</or>
			<then>
			    <!-- Do Nothing for SunOS, HP-UX, AIX and zLinux. The exec command is failing for studio-tools -initialize.-->
            </then>
			
            <elseif>
                <and>
                    <os family="unix"/>
                    <not>
                        <os family="mac"/>
                    </not>
                </and>
            <then>
                <chmod file="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio" perm="755"/>
                <exec executable="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio">
                    <arg value="-initialize"/>
                </exec>
            </then>
            </elseif>
		</if>
        
        
        <if>
            <os family="mac"/>
        <then>
            <chmod file="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.app/Contents/MacOS/studio" perm="755"/>
            <exec executable="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.app/Contents/MacOS/studio">
                <arg value="-initialize"/>
            </exec>
        </then>
        </if>
        
        <if>
            <os family="windows"/>
        <then>
            <chmod file="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.exe" perm="755"/>
            <exec executable="${tibco.home}/be/${beVersionShort}/studio/eclipse/studio.exe">
                <arg value="-initialize"/>
            </exec>
        </then>
        </if>        
    </target>
	
	<target name="backup-studio-tools-tra">
		<echo message="Backing up studio-tools-tra" />
		<mkdir dir="${tibco.home}/be/5.6/backup/5.6.1_pre/studio/bin" />
		<move todir="${tibco.home}/be/5.6/backup/5.6.1_pre/studio/bin">
			<fileset dir="${tibco.home}/be/5.6/studio/bin">
				<include name="studio-tools.tra"/>	
			</fileset>
		</move>
	</target>
	
	<target name="backup-designtime-plugins">
			<echo message="Backing up designtime plugins" />
			<mkdir dir="${tibco.home}/be/5.6/backup/5.6.1_pre/studio/eclipse/plugins" />
			<move todir="${tibco.home}/be/5.6/backup/5.6.1_pre/studio/eclipse/plugins">
				<fileset dir="${tibco.home}/be/5.6/studio/eclipse/plugins">
					<include name="com.tibco.cep.diagramming_5.6.*.jar*"/>						
					<include name="com.tibco.cep.rt_5.6.*.jar*"/>						
					<include name="com.tibco.cep.sharedresource_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.application_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.cli_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.common_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.core_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.debug.core_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.debug.ui_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.mapper_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.tester.core_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.tester.ui_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.ui.editors_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.ui.navigator_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.ui_5.6.*.jar*"/>						
					<include name="com.tibco.cep.tpcl_5.6.*.jar*"/>						
					<include name="com.tibco.cep.tra_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.wizard.hawk_5.6.*.jar*"/>						
					<include name="com.tibco.cep.studio.wizard.as_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.ws_5.6.*.jar*"/>
					<include name="com.tibco.xml.*.jar*"/>
					<include name="com.tibco.cep.studio.xerces_5.6.*.jar*"/>
					<include name="com.tibco.cep.thirdparty_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.util_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.mapper.ui_5.6.*.jar*"/>
					<include name="com.tibco.cep.studio.dashboard.rt_5.6.*.jar*"/>
					<include name="com.tibco.cep.security_5.6.*.jar*"/>
					<include name="com.tibco.cep.eventstreamprocessing_5.6.*.jar*"/>
					<include name="com.tibco.cep.eventstreamprocessing.common_5.6.*.jar*"/>
					<include name="com.tibco.cep.datamodeling.common_5.6.*.jar*"/>
					<include name="com.tibco.cep.liveview_5.6.*.jar" />
					<include name="com.tibco.cep.datamodeling_5.6.*.jar" />
					<include name="com.tibco.cep.decision.table.capabilities_5.6.*.jar" />
					<include name="com.tibco.cep.decision.table.common_5.6.*.jar" />
					<include name="com.tibco.cep.decision.table.core_5.6.*.jar" />
					<include name="com.tibco.cep.decision.table.ui_5.6.*.jar" />
					<include name="com.tibco.cep.decision.tree.common_5.6.*.jar" />
					<include name="com.tibco.cep.decision.tree.core_5.6.*.jar" />
					<include name="com.tibco.cep.decision.tree.ui_5.6.*.jar" />
					<include name="com.tibco.cep.sharedresource.as3_5.6.*.jar" />
					<include name="com.tibco.cep.sharedresource.ascon_5.6.*.jar" />
					<include name="com.tibco.cep.sharedresource.ftl_5.6.*.jar" />
					<include name="com.tibco.cep.sharedresource.hawk_5.6.*.jar" />
					<include name="com.tibco.cep.sharedresource.mqtt_5.6.*.jar" />
					<include name="com.tibco.cep.studio.cluster.topology_5.6.*.jar" />
					<include name="com.tibco.cep.studio.dbconcept_5.6.*.jar" />
					<include name="com.tibco.cep.studio.decision.table.ui_5.6.*.jar" />
					<include name="com.tibco.cep.studio.rms.core_5.6.*.jar" />
					<include name="com.tibco.cep.studio.rms.ui_5.6.*.jar" />
					<include name="com.tibco.cep.studio.streambase_5.6.*.jar" />
					<include name="com.tibco.cep.studio.ui.statemachine_5.6.*.jar" />
					<include name="com.tibco.cep.studio.wizard.ftl_5.6.*.jar" />
					<include name="com.tibco.cep.bpmn.common_5.6.*.jar" />
					<include name="com.tibco.cep.bpmn.core_5.6.*.jar" />
					<include name="com.tibco.cep.bpmn.rt_5.6.*.jar" />
					<include name="com.tibco.cep.bpmn.ui_5.6.*.jar" />
					<exclude name="*5.6.1.jar"/>
				</fileset>
			</move>
		</target>
	
	
	
	
	
	
	
	
</project>
